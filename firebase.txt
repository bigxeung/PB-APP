 ğŸ“± Firebase ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì—°ë™ ê°€ì´ë“œ (React Native)

  ğŸ”§ 1. Firebase í”„ë¡œì íŠ¸ ì„¤ì •

  Firebase Console: https://console.firebase.google.com/project/my-lora-auth

  1. í”„ë¡œì íŠ¸ ID: my-lora-auth
  2. ì¸ì¦ ë°©ì‹: Email/Password í™œì„±í™”ë¨ âœ…
  3. ì•± ë“±ë¡:
    - Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì¼ë°˜ â†’ ì•± ì¶”ê°€
    - Android: google-services.json ë‹¤ìš´ë¡œë“œ â†’ android/app/ í´ë”ì— ì €ì¥
    - iOS: GoogleService-Info.plist ë‹¤ìš´ë¡œë“œ â†’ Xcodeì—ì„œ í”„ë¡œì íŠ¸ì— ì¶”ê°€

  ---
  ğŸ“¦ 2. Firebase SDK ì„¤ì¹˜

  # React Native Firebase ì„¤ì¹˜
  npm install @react-native-firebase/app @react-native-firebase/auth

  # iOS ì˜ì¡´ì„± ì„¤ì¹˜
  cd ios && pod install && cd ..

  Android ì„¤ì • (android/build.gradle):
  buildscript {
      dependencies {
          classpath 'com.google.gms:google-services:4.4.0'
      }
  }

  Android ì„¤ì • (android/app/build.gradle):
  apply plugin: 'com.google.gms.google-services'

  iOS ì„¤ì •: Xcodeì—ì„œ GoogleService-Info.plist íŒŒì¼ì´ í”„ë¡œì íŠ¸ì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸

  ---
  ğŸ” 3. ì¸ì¦ í”Œë¡œìš°

  âœ… íšŒì›ê°€ì… (Sign Up)

  // src/services/authService.ts
  import auth from '@react-native-firebase/auth';
  import axios from 'axios';
  import AsyncStorage from '@react-native-async-storage/async-storage';

  const API_BASE_URL = 'https://lora.blueming.me';

  interface AuthResponse {
    success: boolean;
    data: {
      accessToken: string;
      refreshToken: string;
      user: {
        id: number;
        email: string;
        nickname: string;
        profileImageUrl: string | null;
        role: string;
      };
    };
    error: any;
  }

  export const signUpWithEmail = async (email: string, password: string) => {
    try {
      // 1. Firebase íšŒì›ê°€ì…
      const userCredential = await auth().createUserWithEmailAndPassword(email, password);

      // 2. Firebase ID Token ë°œê¸‰
      const idToken = await userCredential.user.getIdToken();

      // 3. ë°±ì—”ë“œë¡œ ID Token ì „ì†¡í•˜ì—¬ JWT ë°œê¸‰
      const response = await axios.post<AuthResponse>(
        `${API_BASE_URL}/api/auth/firebase/register`,
        { idToken }
      );

      if (response.data.success) {
        // 4. JWT í† í° ì €ì¥
        await AsyncStorage.setItem('accessToken', response.data.data.accessToken);
        await AsyncStorage.setItem('refreshToken', response.data.data.refreshToken);

        return {
          success: true,
          user: response.data.data.user
        };
      }

      return { success: false, error: response.data.error };
    } catch (error: any) {
      console.error('Sign up error:', error);

      // Firebase ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
      if (error.code === 'auth/email-already-in-use') {
        return { success: false, error: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' };
      } else if (error.code === 'auth/weak-password') {
        return { success: false, error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' };
      } else if (error.code === 'auth/invalid-email') {
        return { success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.' };
      }

      return { success: false, error: 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
    }
  };

  ---
  âœ… ë¡œê·¸ì¸ (Sign In)

  export const signInWithEmail = async (email: string, password: string) => {
    try {
      // 1. Firebase ë¡œê·¸ì¸
      const userCredential = await auth().signInWithEmailAndPassword(email, password);

      // 2. Firebase ID Token ë°œê¸‰
      const idToken = await userCredential.user.getIdToken();

      // 3. ë°±ì—”ë“œë¡œ ID Token ì „ì†¡í•˜ì—¬ JWT ë°œê¸‰
      const response = await axios.post<AuthResponse>(
        `${API_BASE_URL}/api/auth/firebase/login`,
        { idToken }
      );

      if (response.data.success) {
        // 4. JWT í† í° ì €ì¥
        await AsyncStorage.setItem('accessToken', response.data.data.accessToken);
        await AsyncStorage.setItem('refreshToken', response.data.data.refreshToken);

        return {
          success: true,
          user: response.data.data.user
        };
      }

      return { success: false, error: response.data.error };
    } catch (error: any) {
      console.error('Sign in error:', error);

      // Firebase ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
        return { success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' };
      } else if (error.code === 'auth/invalid-email') {
        return { success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.' };
      } else if (error.code === 'auth/user-disabled') {
        return { success: false, error: 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.' };
      }

      return { success: false, error: 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
    }
  };

  ---
  âœ… íšŒì›ê°€ì…/ë¡œê·¸ì¸ í™”ë©´ ì˜ˆì‹œ

  // src/screens/RegisterScreen.tsx
  import React, { useState } from 'react';
  import { View, TextInput, Button, Text, Alert } from 'react-native';
  import { signUpWithEmail } from '../services/authService';

  const RegisterScreen = ({ navigation }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSignUp = async () => {
      if (!email || !password) {
        Alert.alert('ì˜¤ë¥˜', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      setLoading(true);
      const result = await signUpWithEmail(email, password);
      setLoading(false);

      if (result.success) {
        Alert.alert('ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        navigation.navigate('Main');
      } else {
        Alert.alert('ì˜¤ë¥˜', result.error);
      }
    };

    return (
      <View style={{ padding: 20 }}>
        <Text style={{ fontSize: 24, marginBottom: 20 }}>íšŒì›ê°€ì…</Text>

        <TextInput
          placeholder="ì´ë©”ì¼"
          value={email}
          onChangeText={setEmail}
          keyboardType="email-address"
          autoCapitalize="none"
          style={{ borderWidth: 1, padding: 10, marginBottom: 10 }}
        />

        <TextInput
          placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
          value={password}
          onChangeText={setPassword}
          secureTextEntry
          style={{ borderWidth: 1, padding: 10, marginBottom: 20 }}
        />

        <Button title={loading ? 'ì²˜ë¦¬ ì¤‘...' : 'íšŒì›ê°€ì…'} onPress={handleSignUp} disabled={loading} />

        <Button title="ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ" onPress={() => navigation.navigate('Login')} />
      </View>
    );
  };

  export default RegisterScreen;

  // src/screens/LoginScreen.tsx
  import React, { useState } from 'react';
  import { View, TextInput, Button, Text, Alert } from 'react-native';
  import { signInWithEmail } from '../services/authService';

  const LoginScreen = ({ navigation }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSignIn = async () => {
      if (!email || !password) {
        Alert.alert('ì˜¤ë¥˜', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      setLoading(true);
      const result = await signInWithEmail(email, password);
      setLoading(false);

      if (result.success) {
        navigation.navigate('Main');
      } else {
        Alert.alert('ì˜¤ë¥˜', result.error);
      }
    };

    return (
      <View style={{ padding: 20 }}>
        <Text style={{ fontSize: 24, marginBottom: 20 }}>ë¡œê·¸ì¸</Text>

        <TextInput
          placeholder="ì´ë©”ì¼"
          value={email}
          onChangeText={setEmail}
          keyboardType="email-address"
          autoCapitalize="none"
          style={{ borderWidth: 1, padding: 10, marginBottom: 10 }}
        />

        <TextInput
          placeholder="ë¹„ë°€ë²ˆí˜¸"
          value={password}
          onChangeText={setPassword}
          secureTextEntry
          style={{ borderWidth: 1, padding: 10, marginBottom: 20 }}
        />

        <Button title={loading ? 'ì²˜ë¦¬ ì¤‘...' : 'ë¡œê·¸ì¸'} onPress={handleSignIn} disabled={loading} />

        <Button title="íšŒì›ê°€ì…" onPress={() => navigation.navigate('Register')} />
      </View>
    );
  };

  export default LoginScreen;

  ---
  ğŸ”‘ 4. JWT í† í° ì‚¬ìš© (Axios Interceptor)

  // src/api/axiosInstance.ts
  import axios from 'axios';
  import AsyncStorage from '@react-native-async-storage/async-storage';

  const API_BASE_URL = 'https://lora.blueming.me';

  const axiosInstance = axios.create({
    baseURL: API_BASE_URL,
    timeout: 10000,
  });

  // ìš”ì²­ ì¸í„°ì…‰í„°: ëª¨ë“  ìš”ì²­ì— JWT í† í° ì¶”ê°€
  axiosInstance.interceptors.request.use(
    async (config) => {
      const accessToken = await AsyncStorage.getItem('accessToken');
      if (accessToken) {
        config.headers.Authorization = `Bearer ${accessToken}`;
      }
      return config;
    },
    (error) => Promise.reject(error)
  );

  // ì‘ë‹µ ì¸í„°ì…‰í„°: 401 ì—ëŸ¬ ì‹œ í† í° ê°±ì‹ 
  axiosInstance.interceptors.response.use(
    (response) => response,
    async (error) => {
      const originalRequest = error.config;

      // 401 Unauthorized && ì¬ì‹œë„ ì•„ì§ ì•ˆ í•¨
      if (error.response?.status === 401 && !originalRequest._retry) {
        originalRequest._retry = true;

        try {
          // Refresh Tokenìœ¼ë¡œ ìƒˆ Access Token ë°œê¸‰
          const refreshToken = await AsyncStorage.getItem('refreshToken');

          const response = await axios.post(`${API_BASE_URL}/api/auth/refresh`, {
            refreshToken
          });

          if (response.data.success) {
            const { accessToken, refreshToken: newRefreshToken } = response.data.data;

            // ìƒˆ í† í° ì €ì¥
            await AsyncStorage.setItem('accessToken', accessToken);
            await AsyncStorage.setItem('refreshToken', newRefreshToken);

            // ì›ë˜ ìš”ì²­ ì¬ì‹œë„
            originalRequest.headers.Authorization = `Bearer ${accessToken}`;
            return axiosInstance(originalRequest);
          }
        } catch (refreshError) {
          // Refresh ì‹¤íŒ¨ â†’ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
          await AsyncStorage.removeItem('accessToken');
          await AsyncStorage.removeItem('refreshToken');

          // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™ (Navigationì€ ë³„ë„ ì²˜ë¦¬ í•„ìš”)
          console.error('Token refresh failed. Please login again.');
          return Promise.reject(refreshError);
        }
      }

      return Promise.reject(error);
    }
  );

  export default axiosInstance;

  ---
  ğŸ”„ 5. API í˜¸ì¶œ ì˜ˆì‹œ

  // src/services/modelService.ts
  import axiosInstance from '../api/axiosInstance';

  // ëª¨ë¸ ëª©ë¡ ì¡°íšŒ
  export const getModels = async () => {
    try {
      const response = await axiosInstance.get('/api/models');
      return response.data;
    } catch (error) {
      console.error('Get models error:', error);
      throw error;
    }
  };

  // ëª¨ë¸ ìƒì„±
  export const createModel = async (modelData: any) => {
    try {
      const response = await axiosInstance.post('/api/models', modelData);
      return response.data;
    } catch (error) {
      console.error('Create model error:', error);
      throw error;
    }
  };

  ---
  ğŸšª 6. ë¡œê·¸ì•„ì›ƒ

  // src/services/authService.ts
  import auth from '@react-native-firebase/auth';
  import AsyncStorage from '@react-native-async-storage/async-storage';
  import axiosInstance from '../api/axiosInstance';

  export const logout = async () => {
    try {
      // 1. ë°±ì—”ë“œ ë¡œê·¸ì•„ì›ƒ (Refresh Token ë¬´íš¨í™”)
      const refreshToken = await AsyncStorage.getItem('refreshToken');
      if (refreshToken) {
        await axiosInstance.post('/api/auth/logout', { refreshToken });
      }

      // 2. Firebase ë¡œê·¸ì•„ì›ƒ
      await auth().signOut();

      // 3. ë¡œì»¬ í† í° ì‚­ì œ
      await AsyncStorage.removeItem('accessToken');
      await AsyncStorage.removeItem('refreshToken');

      return { success: true };
    } catch (error) {
      console.error('Logout error:', error);
      return { success: false, error };
    }
  };

  ---
  ğŸ“± 7. ìë™ ë¡œê·¸ì¸ ì²´í¬

  // App.tsx ë˜ëŠ” AuthProvider
  import React, { useEffect, useState } from 'react';
  import AsyncStorage from '@react-native-async-storage/async-storage';
  import auth from '@react-native-firebase/auth';

  const App = () => {
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
      checkLoginStatus();
    }, []);

    const checkLoginStatus = async () => {
      try {
        const accessToken = await AsyncStorage.getItem('accessToken');
        const firebaseUser = auth().currentUser;

        if (accessToken && firebaseUser) {
          setIsLoggedIn(true);
        } else {
          setIsLoggedIn(false);
        }
      } catch (error) {
        console.error('Check login status error:', error);
        setIsLoggedIn(false);
      } finally {
        setIsLoading(false);
      }
    };

    if (isLoading) {
      return <LoadingScreen />;
    }

    return isLoggedIn ? <MainNavigator /> : <AuthNavigator />;
  };

  ---
  ğŸŒ 8. ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸

  Base URL: https://lora.blueming.me

  | ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸                  | ì„¤ëª…                |
  |--------|-----------------------------|---------------------|
  | POST   | /api/auth/firebase/register | Firebase íšŒì›ê°€ì…   |
  | POST   | /api/auth/firebase/login    | Firebase ë¡œê·¸ì¸     |
  | POST   | /api/auth/refresh           | Access Token ê°±ì‹    |
  | POST   | /api/auth/logout            | ë¡œê·¸ì•„ì›ƒ            |
  | GET    | /api/users/me               | í˜„ì¬ ìœ ì € ì •ë³´ ì¡°íšŒ |
  | PATCH  | /api/users/me               | í”„ë¡œí•„ ìˆ˜ì •         |

  Swagger ë¬¸ì„œ: https://lora.blueming.me/swagger-ui.html

  ---
  âš ï¸ 9. ì£¼ìš” Firebase ì—ëŸ¬ ì½”ë“œ

  | ì½”ë“œ                      | ì„¤ëª…                      |
  |---------------------------|---------------------------|
  | auth/email-already-in-use | ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼     |
  | auth/weak-password        | ë¹„ë°€ë²ˆí˜¸ê°€ 6ì ë¯¸ë§Œ       |
  | auth/invalid-email        | ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ |
  | auth/user-not-found       | ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ì      |
  | auth/wrong-password       | ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸           |
  | auth/user-disabled        | ë¹„í™œì„±í™”ëœ ê³„ì •           |

  ---
  ğŸ“ 10. ë¬¸ì˜ì‚¬í•­

  - Swagger ë¬¸ì„œ: https://lora.blueming.me/swagger-ui.html
  - Firebase Console: https://console.firebase.google.com/project/my-lora-auth
  - ë°±ì—”ë“œ ê°œë°œì: (ì—°ë½ì²˜)

  ---
  ì´ ê°€ì´ë“œë¥¼ React Native ì•± ê°œë°œìì—ê²Œ ì „ë‹¬í•˜ì‹œë©´ ë©ë‹ˆë‹¤! ğŸ‰